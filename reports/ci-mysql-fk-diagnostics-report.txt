تقرير تفصيلي لتنفيذ تحليلات قيود العلاقات (MySQL FK) وتحديثات CI

ملخص تنفيذي
- أُجريت سلسلة تعديلات على ملف CI لإضافة تحليلات شاملة لمشكلات قيود العلاقات في MySQL ونشر النتائج في الملخص والسجلات ورفعها ضمن الـ artifacts.
- شملت التحليلات فجوات الفهارس على طرفي العلاقة (الابن والأب)، عدم تطابق النوع/الترميز/التصنيف، وعدم تطابق خاصية unsigned.
- وُلدت اقتراحات إصلاح تلقائية بصيغتي SQL وMarkdown، ونُشرت في Job Summary وسجلات artifacts-consumer لتسهيل التطبيق.

نطاق العمل
- تعديل مسار عمل GitHub Actions في `ci.yml` لإضافة خطوات تحليل جديدة ونشرها.
- توليد ملفات تحليل وإصلاح ضمن مجلد `reports/` ورفعها ضمن artifact `ci-test-results`.
- تحسين دقة كشف عدم التطابق بإرجاع `COLUMN_TYPE` الكامل.

التسلسل الزمني للمراحل
1) إدراج وطباعة نتائج التحليل الأولي:
   - توليد `reports/mysql-fk-index-gaps.txt` (جهة الابن) و`reports/mysql-fk-type-mismatches.txt`.
   - طباعة أول 50 سطر من كلا الملفين في سجلات Job `artifacts-consumer`.
   - إدراج أعداد هذه الحالات في `diagnostics-alerts.md` و`diagnostics-summary.md` ورفع `reports/` ضمن artifact.

2) تحسين كشف عدم التطابق:
   - تعديل الاستعلام لإرجاع `child.COLUMN_TYPE` و`parent.COLUMN_TYPE` لضمان اقتراحات تعديل أعمدة دقيقة (تشمل الطول وunsigned).

3) إضافة توليد اقتراحات الإصلاح:
   - إنشاء خطوة "Generate fix suggestions (indexes and column types)".
   - توليد `reports/fix-suggestions.sql` (أوامر ADD INDEX وMODIFY COLUMN وCONVERT/COLLATE عند الحاجة).
   - توليد `reports/fix-suggestions.md` (ملخص بشري منسّق).
   - نشر "Fix Suggestions" في Job Summary (أول 200 سطر) وطباعة مقتطفات في سجلات `artifacts-consumer`.

4) تحليل فجوات فهارس الجهة الأب (Referenced columns):
   - مقارنة فهارس الجهة الأب مع أعمدة الـ FK المرجعية وإخراج الفجوات في `reports/mysql-fk-parent-index-gaps.txt`.

5) كشف عدم تطابق unsigned:
   - الاستعلام من `information_schema.COLUMNS` لاستخراج حالات اختلاف unsigned بين الابن والأب.
   - إخراج النتائج في `reports/mysql-fk-unsigned-mismatches.txt`.

6) توسيع الاقتراحات والتنبيهات والسجلات:
   - دمج اقتراحات لفهارس الجهة الأب وعدم تطابق unsigned ضمن `fix-suggestions.sql`/`.md`.
   - إضافة تنبيهات جديدة لعدد الحالات في الملخص.
   - تحديث السجلات بتسميات واضحة: "FK Index Gaps (child side)", "FK Parent Index Gaps (parent side)", "FK Unsigned Mismatches".

7) إصلاحات نحوية وتشغيلية:
   - إصلاح شرط فحص MyISAM: استخدام `if grep -q "MyISAM" reports/mysql-engines.txt; then ... fi` دون أقواس خاطئة.

المشكلات والأخطاء المكتشفة
- فجوات فهارس مركّبة لأعمدة قيود FK على جهة الابن تؤدي لعمليات فحص كاملة وتباطؤ.
- فجوات فهارس مركّبة على الجهة الأب (الأعمدة المرجعية)، تُضعف أداء JOIN والتحققات المرجعية.
- عدم تطابق النوع الكامل (`COLUMN_TYPE`) بين العمود الابن والمرجعي (الطول/unsigned).
- اختلاف `charset` و`collation` بين الطرفين قد يسبب رفض القيود أو سلوك غير متوقع.
- حالات عدم تطابق unsigned تؤثر على تخزين ومقارنة القيم.
- خطأ نحوي في شرط فحص MyISAM منع الكشف الصحيح في بعض الحالات.

الإصلاحات المنفذة
- تحديث استعلام كشف عدم التطابق لإرجاع النوع الكامل لكل من الابن والأب.
- إضافة خطوة توليد اقتراحات الإصلاح:
  - `fix-suggestions.sql`: أوامر `ADD INDEX` لسد فجوات الفهارس (ابن/أب)، `MODIFY COLUMN` لمواءمة النوع الكامل، وأوامر تحويل/توحيد الترميز/التصنيف عند الحاجة.
  - `fix-suggestions.md`: ملخص بشري يربط كل جدول/عمود بالاقتراح المناسب.
- نشر الاقتراحات في Job Summary والسجلات لسهولة الوصول.
- تحليل فجوات فهارس الجهة الأب وإخراجها في `mysql-fk-parent-index-gaps.txt`.
- كشف عدم تطابق unsigned وإخراجه في `mysql-fk-unsigned-mismatches.txt`.
- توسيع التنبيهات في `diagnostics-summary.md` و`diagnostics-alerts.md` لعرض أعداد الحالات الجديدة.
- إصلاح شرط `grep` لـ MyISAM.
- ضمان رفع كامل مجلد `reports/` ضمن artifact `ci-test-results`.

الملفات الناتجة
- `reports/mysql-fk-index-gaps.txt` (جهة الابن).
- `reports/mysql-fk-parent-index-gaps.txt` (جهة الأب).
- `reports/mysql-fk-type-mismatches.txt` (النوع/الترميز/التصنيف).
- `reports/mysql-fk-unsigned-mismatches.txt` (اختلاف unsigned).
- `reports/fix-suggestions.sql` و`reports/fix-suggestions.md` (اقتراحات تنفيذية وبشرية).

النشر في الملخص والسجلات
- الملخص (Job Summary):
  - قسم "Alerts": يعرض أعداد فجوات الفهارس (ابن/أب)، عدم تطابق النوع، عدم تطابق unsigned.
  - قسم "Fix Suggestions": يعرض أول 200 سطر من `fix-suggestions.md`.
- سجلات `artifacts-consumer`:
  - تعرض مقتطفات من الملفات التحليلية والاقتراحات: child/parent index gaps، unsigned mismatches، fix suggestions (نص وSQL).
- artifacts:
  - رفع `ci-test-results/reports/` بالكامل مع جميع الملفات.

الوضع الحالي
- الفرع `fix/ci-mysql-migrations` يحتوي كل التعديلات على `ci.yml` وتم دفعها.
- التشغيلات الجديدة تنتج الملفات المذكورة وتعرضها في الملخص والسجلات وترفعها ضمن الـ artifacts.

القيود والاعتبارات
- اقتراحات تعديل الأعمدة قد تتطلب نوافذ صيانة ويجب اختبارها على بيئة غير الإنتاج.
- توحيد charset/collation يؤثر على الفرز والبحث، يلزم اختبار مسبق.
- ترتيب الهجرات مهم لضمان نجاح القيود: فهارس أولًا ثم قيود FK؛ تعديل الجهة الأب قبل الابن.

التوصيات العملية
- طبّق الفهارس أولًا من `fix-suggestions.sql` لتحسين الأداء بسرعة وبمخاطر منخفضة.
- اختبر تعديلات الأعمدة (MODIFY) على بيئة تطوير/اختبار قبل الإنتاج، وانظر لتأثير الطول وunsigned على البيانات.
- وحّد `charset`/`collation` عند وجود اختلاف، بعد تقييم تأثيره على التطبيق.
- أعد ترتيب الهجرات بحيث تُنشأ الجهة الأب وتُعدّل أعمدتها قبل قيود الجهة الابن.
- نفّذ اختبارات التكامل ومسارات CRUD المتعلقة بالجداول المتأثرة بعد كل تغيير.
- احتفظ بنسخ احتياطية قبل تغييرات الأعمدة الكبيرة وراقب الأداء بعد إضافة الفهارس.

الخطوات التالية المقترحة
- شاركني محتوى الملفات الناتجة من آخر تشغيل (Alerts، index gaps، type/unsigned mismatches، fix suggestions).
- سأحوّلها مباشرة إلى هجرات دقيقة: فهارس مركّبة بالترتيب الصحيح، تعديل الأعمدة لمطابقة `COLUMN_TYPE`، وتوحيد الترميز/التصنيف.
- خيار إضافي: إضافة Job اختياري لتطبيق `fix-suggestions.sql` تلقائيًا على قاعدة اختبار منفصلة داخل CI، ورفع نتائج التنفيذ دون التأثير على الإنتاج.
