<?php

declare(strict_types=1);

namespace Tests\Unit\Controllers;

use App\Http\Controllers\AnalyticsController;
use App\Models\User;
use App\Services\BehaviorAnalysisService;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Illuminate\Http\JsonResponse;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Validator;
use Illuminate\Validation\ValidationException;
use Mockery;
use Tests\TestCase;

class AnalyticsControllerTest extends TestCase
{
    use RefreshDatabase;

    private AnalyticsController $controller;

    private BehaviorAnalysisService|Mockery\MockInterface $serviceMock;

    private User $user;

    private Request $requestMock;

    protected function setUp(): void
    {
        parent::setUp();
        $this->serviceMock = Mockery::mock(BehaviorAnalysisService::class);
        $this->controller = new AnalyticsController($this->serviceMock);
        $this->user = User::factory()->create();
        $this->requestMock = Mockery::mock(Request::class)->makePartial();
    }

    protected function tearDown(): void
    {
        Mockery::close();
        parent::tearDown();
    }

    public function test_user_analytics_returns_analytics_for_authenticated_user(): void
    {
        // Arrange
        $analyticsData = ['key' => 'value'];
        $this->serviceMock->shouldReceive('getUserAnalytics')
            ->with($this->user)
            ->once()
            ->andReturn($analyticsData);
        $this->requestMock->shouldReceive('user')
            ->andReturn($this->user);

        // Act
        $response = $this->controller->userAnalytics($this->requestMock);

        // Assert
        $this->assertInstanceOf(JsonResponse::class, $response);
        $this->assertEquals(200, $response->getStatusCode());
        $this->assertEquals(['analytics' => $analyticsData], $response->getData(true));
    }

    public function test_user_analytics_returns_unauthorized_for_unauthenticated_user(): void
    {
        // Arrange
        $this->requestMock->shouldReceive('user')
            ->andReturn(null);

        // Act
        $response = $this->controller->userAnalytics($this->requestMock);

        // Assert
        $this->assertInstanceOf(JsonResponse::class, $response);
        $this->assertEquals(401, $response->getStatusCode());
        $this->assertEquals(['error' => 'Unauthorized'], $response->getData(true));
    }

    public function test_site_analytics_returns_site_analytics(): void
    {
        // Arrange
        $analyticsData = ['site_key' => 'site_value'];
        $this->serviceMock->shouldReceive('getSiteAnalytics')
            ->once()
            ->andReturn($analyticsData);

        // Act
        $response = $this->controller->siteAnalytics();

        // Assert
        $this->assertInstanceOf(JsonResponse::class, $response);
        $this->assertEquals(200, $response->getStatusCode());
        $this->assertEquals(['analytics' => $analyticsData], $response->getData(true));
    }

    public function test_track_behavior_returns_success_for_valid_authenticated_request(): void
    {
        // Arrange
        $action = 'test_action';
        $data = ['key' => 'value'];
        $validated = ['action' => $action, 'data' => $data];
        $this->requestMock->shouldReceive('validate')
            ->with([
                'action' => 'required|string|max:50',
                'data' => 'nullable|array',
            ])
            ->andReturn($validated);
        $this->requestMock->shouldReceive('user')
            ->andReturn($this->user);
        $this->serviceMock->shouldReceive('trackUserBehavior')
            ->with($this->user, $action, $data)
            ->once();

        // Act
        $response = $this->controller->trackBehavior($this->requestMock);

        // Assert
        $this->assertInstanceOf(JsonResponse::class, $response);
        $this->assertEquals(200, $response->getStatusCode());
        $this->assertEquals([
            'success' => true,
            'message' => 'تم تسجيل السلوك بنجاح',
        ], $response->getData(true));
    }

    public function test_track_behavior_returns_unauthorized_for_unauthenticated_user(): void
    {
        // Arrange
        $validated = ['action' => 'test', 'data' => []];
        $this->requestMock->shouldReceive('validate')
            ->with([
                'action' => 'required|string|max:50',
                'data' => 'nullable|array',
            ])
            ->andReturn($validated);
        $this->requestMock->shouldReceive('user')
            ->andReturn(null);

        // Act
        $response = $this->controller->trackBehavior($this->requestMock);

        // Assert
        $this->assertInstanceOf(JsonResponse::class, $response);
        $this->assertEquals(401, $response->getStatusCode());
        $this->assertEquals(['error' => 'Unauthorized'], $response->getData(true));
    }

    public function test_track_behavior_fails_validation_for_invalid_action(): void
    {
        // Arrange
        $validator = Validator::make([], ['action' => 'required']);
        $this->requestMock->shouldReceive('validate')
            ->with([
                'action' => 'required|string|max:50',
                'data' => 'nullable|array',
            ])
            ->andThrow(new ValidationException($validator));

        // Act & Assert
        $this->expectException(ValidationException::class);
        $this->controller->trackBehavior($this->requestMock);
    }

    public function test_user_analytics_throws_exception_when_service_fails(): void
    {
        // Arrange
        $this->serviceMock->shouldReceive('getUserAnalytics')
            ->with($this->user)
            ->once()
            ->andThrow(new \Exception('Service error'));
        $this->requestMock->shouldReceive('user')
            ->andReturn($this->user);

        // Act & Assert
        $this->expectException(\Exception::class);
        $this->controller->userAnalytics($this->requestMock);
    }

    public function test_site_analytics_throws_exception_when_service_fails(): void
    {
        // Arrange
        $this->serviceMock->shouldReceive('getSiteAnalytics')
            ->once()
            ->andThrow(new \Exception('Service error'));

        // Act & Assert
        $this->expectException(\Exception::class);
        $this->controller->siteAnalytics();
    }

    public function test_track_behavior_throws_exception_when_service_fails(): void
    {
        // Arrange
        $action = 'test_action';
        $data = ['key' => 'value'];
        $validated = ['action' => $action, 'data' => $data];
        $this->requestMock->shouldReceive('validate')
            ->with([
                'action' => 'required|string|max:50',
                'data' => 'nullable|array',
            ])
            ->andReturn($validated);
        $this->requestMock->shouldReceive('user')
            ->andReturn($this->user);
        $this->serviceMock->shouldReceive('trackUserBehavior')
            ->with($this->user, $action, $data)
            ->once()
            ->andThrow(new \Exception('Service error'));

        // Act & Assert
        $this->expectException(\Exception::class);
        $this->controller->trackBehavior($this->requestMock);
    }
}
