#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "🚀 Running pre-commit checks with lint-staged..."

# Check if vendor directory exists
if [ ! -d "vendor" ]; then
    echo "⚠️  WARNING: vendor directory not found!"
    echo "📦 Installing dependencies with composer..."
    composer install --no-interaction --prefer-dist --optimize-autoloader
    if [ $? -ne 0 ]; then
        echo "❌ Failed to install composer dependencies. Please run 'composer install' manually."
        exit 1
    fi
fi

# Check if node_modules directory exists
if [ ! -d "node_modules" ]; then
    echo "⚠️  WARNING: node_modules directory not found!"
    echo "📦 Installing NPM dependencies..."
    # Prefer clean, reproducible install when lockfile exists
    if [ -f "package-lock.json" ]; then
        npm ci --prefer-offline || npm install
    else
        npm install
    fi
    if [ $? -ne 0 ]; then
        echo "❌ Failed to install NPM dependencies. Please run 'npm install' manually."
        exit 1
    fi
fi

npx lint-staged
